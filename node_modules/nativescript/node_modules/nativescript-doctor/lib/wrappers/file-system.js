"use strict";
const fs = require("fs");
const path = require("path");
const yauzl = require("yauzl");
const util = require("util");
const access = util.promisify(fs.access);
const mkdir = util.promisify(fs.mkdir);
class FileSystem {
    exists(path) {
        return fs.existsSync(path);
    }
    extractZip(pathToZip, outputDir) {
        return new Promise((resolve, reject) => {
            yauzl.open(pathToZip, { autoClose: true, lazyEntries: true }, (openError, zipFile) => {
                if (openError) {
                    return reject(openError);
                }
                zipFile.on('entry', entry => {
                    const fn = entry.fileName;
                    if (/\/$/.test(fn)) {
                        return zipFile.readEntry();
                    }
                    zipFile.openReadStream(entry, (openStreamError, stream) => {
                        if (openStreamError) {
                            return reject(openStreamError);
                        }
                        ;
                        const filePath = `${outputDir}/${fn}`;
                        return createParentDirsIfNeeded(filePath)
                            .catch(createParentDirError => reject(createParentDirError))
                            .then(() => {
                            const outfile = fs.createWriteStream(filePath);
                            stream.once('end', () => {
                                zipFile.readEntry();
                            });
                            stream.pipe(outfile);
                        });
                    });
                });
                zipFile.once('end', () => resolve());
                zipFile.readEntry();
            });
        });
    }
    readDirectory(path) {
        return fs.readdirSync(path);
    }
    readJson(path, options) {
        const content = fs.readFileSync(path, options);
        return JSON.parse(content.toString());
    }
}
exports.FileSystem = FileSystem;
function createParentDirsIfNeeded(filePath) {
    const dirs = path.dirname(filePath).split(path.sep);
    return dirs.reduce((p, dir) => p.then(parent => {
        const current = `${parent}${path.sep}${dir}`;
        return access(current)
            .catch(e => mkdir(current))
            .then(() => current);
    }), Promise.resolve(''));
}
